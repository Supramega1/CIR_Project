<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Yumeye — Recipe Generator</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f9f9fb;
      color: #333;
    }
    h1 { text-align: center; color: #d35400; }
    
    /* Logout button in top right corner */
    .logout-container {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    #logoutBtn {
      padding: 10px 20px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      background: #e74c3c;
      color: white;
    }
    #logoutBtn:hover {
      background: #c0392b;
    }

    .controls { text-align: center; margin: 30px 0; }
    button {
      padding: 12px 24px;
      margin: 0 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #startBtn { background: #27ae60; color: white; }
    #startBtn:hover { background: #219653; }
    #startBtn:disabled {
      background: #95a5a6 !important;
      cursor: not-allowed;
      opacity: 0.7;
    }
    #stopBtn { background: #c0392b; color: white; }
    #stopBtn:hover { background: #e74c3c; }
    #stopBtn:disabled { background: #95a5a6; cursor: not-allowed;opacity: 0.7; }

    #openCamera{
      margin-top: 15px;
      background: #b1d411;
      color: white;
    }
    #openCamera:hover{background: #839e0a;}
    #openCamera:disabled{ background: #95a5a6; cursor: not-allowed;opacity: 0.7; }

    #photoAction{ background: #c0392b; color: white; }
    #photoAction:hover { background: #e74c3c; }
    #photoAction:disabled { background: #95a5a6; cursor: not-allowed;opacity: 0.7; }

    .text-input-container {
      margin: 30px 0;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    textarea {
      width: 95%;
      height: 120px;
      padding: 10px;
      font-size: 16px;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #textSubmit {
      margin-top: 15px;
      background: #2980b9;
      color: white;
    }
    #textSubmit:hover { background: #2471a3; }

    #textSubmit:disabled { background: #95a5a6; cursor: not-allowed;opacity: 0.7; }


    .output {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none;
    }
    .output.show { display: block; animation: fadeIn 0.5s; }
    .transcription { font-style: italic; color: #7f8c8d; margin-bottom: 15px; }
    .recipe { line-height: 1.7; }
    .recipe h3 { color: #d35400; margin-top: 20px; }
    .recipe ul, .recipe ol { padding-left: 20px; }

    .loading { text-align: center; color: #3498db; font-style: italic; display: none; }
    .error { color: #e74c3c; background: #fadbd8; padding: 10px; border-radius: 6px; margin-top: 10px; display: none; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <!-- Logout Button -->
  <div class="logout-container">
    <button id="logoutBtn">Log Out</button>
  </div>

  <h1>Yumeye</h1>
  <p style="text-align:center; color:#7f8c8d;">Speak your ingredients → Get a pro recipe</p>

  <div class="controls">
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop & Generate Recipe</button>
  </div>

  <!-- TEXT INPUT MODULE -->
  <div class="text-input-container">
    <h3>Or type your ingredients</h3>
    <textarea id="textInput" placeholder="Ex: chicken, rice, tomato, garlic..."></textarea>
    <button id="textSubmit">Generate Recipe from Text</button>
  </div>

  <!-- IMAGE INPUT MODULE -->
  <div class="text-input-container">
    <h3>Or take a photo of your ingredients</h3>

    <video id="camera" autoplay playsinline style="width:100%; border-radius:12px; display:none;"></video>
    <canvas id="snapshot" style="display:none;"></canvas>

    <div style="margin-top:15px;text-align:center;">
      <button id="openCamera">Open Camera</button>
      <button id="photoAction" disabled>Take & Send Photo</button>
    </div>
  </div>



  <div class="loading" id="loading">Generating your recipe...</div>
  <div class="error" id="error"></div>

  <div class="output" id="output">
    <div class="transcription" id="transcription"></div>
    <div class="recipe" id="recipe"></div>
  </div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const loading = document.getElementById("loading");
    const errorDiv = document.getElementById("error");
    const output = document.getElementById("output");
    const transcriptionEl = document.getElementById("transcription");
    const recipeEl = document.getElementById("recipe");
    const textInput = document.getElementById("textInput");
    const textSubmit = document.getElementById("textSubmit");
    const openCameraBtn = document.getElementById("openCamera");
    const photoActionBtn = document.getElementById("photoAction");
    const video = document.getElementById("camera");
    const canvas = document.getElementById("snapshot");
    const logoutBtn = document.getElementById("logoutBtn");

    let cameraStream = null;

    let mediaRecorder;
    let audioChunks = [];
    let conversationId = localStorage.getItem("conversation_id") || null;

    // LOGOUT HANDLER
    logoutBtn.onclick = async () => {
      try {
        const response = await fetch("/logout", { method: "POST" });
        if (response.ok) {
          // Clear conversation ID from localStorage
          localStorage.removeItem("conversation_id");
          // Redirect to login page
          window.location.href = "/login";
        } else {
          showError("Failed to log out. Please try again.");
        }
      } catch (err) {
        showError("Network error during logout.");
      }
    };

    async function stopTTS() {
      try {
        await fetch("/stop_tts", { method: "GET" });
        console.log("TTS stopped (if running)");
      } catch (err) {
        console.warn("Failed to stop TTS:", err);
      }
    };

    // Start recording
    startBtn.onclick = async () => {
      await stopTTS();
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = uploadAudio;

        mediaRecorder.start();
        textSubmit.disabled = true;
        startBtn.disabled = true;
        openCameraBtn.disabled = true;
        photoActionBtn.disabled = true;
        stopBtn.disabled = false;
        loading.style.display = "none";
        errorDiv.style.display = "none";
        output.classList.remove("show");
      } catch (err) {
        showError("Microphone access denied or not available.");
      }
    };

    // OPEN CAMERA
    openCameraBtn.onclick = async () => {
      await stopTTS();

      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = cameraStream;
        video.style.display = "block";
        photoActionBtn.disabled = false;
        openCameraBtn.disabled = true;
        textSubmit.disabled = true;
        startBtn.disabled = true;
        stopBtn.disabled = true;
      } catch (err) {
        showError("Camera access denied.");
      }
    };

    // TAKE + SEND PHOTO
    photoActionBtn.onclick = async () => {
      if (!cameraStream) return showError("Camera not started.");

      loading.style.display = "block";
      errorDiv.style.display = "none";
      output.classList.remove("show");

      // Take snapshot
      const context = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);

      // Convert to image + send
      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append("image", blob, "photo.jpg");
        if (conversationId) formData.append("conversation_id", conversationId);

        try {
          const response = await fetch("/upload_image", {
            method: "POST",
            body: formData
          });

          const data = await response.json();

          if (response.ok) {
            conversationId = data.conversation_id;
            localStorage.setItem("conversation_id", conversationId);

            transcriptionEl.textContent = `Detected ingredients: ${data.ingredients.join(", ")}`;
            recipeEl.innerHTML = markdownToHtml(data.llm_response);
            output.classList.add("show");
            loading.style.display = "none";
          } else {
            showError(data.error || "Image processing error");
          }

        } catch {
          showError("Failed to reach YOLO server.");
        }
      }, "image/jpeg");

      // Stop camera after sending
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        video.style.display = "none";
        photoActionBtn.disabled = true;

        openCameraBtn.disabled = false;
        startBtn.disabled = false;
        textSubmit.disabled = false;
        stopBtn.disabled = true;
      }
    };


    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        startBtn.disabled = true;
        textSubmit.disabled = true;
        stopBtn.disabled = true;
        openCameraBtn.disabled = true;
        photoActionBtn.disabled = true;
        loading.style.display = "block";
      }
    };

    // Upload audio
    async function uploadAudio() {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const formData = new FormData();
      formData.append("audio", blob, "recording.webm");
      if (conversationId) formData.append("conversation_id", conversationId);

      try {
        const response = await fetch("/upload", { method: "POST", body: formData });
        const data = await response.json();

        if (response.ok) {
          conversationId = data.conversation_id;
          localStorage.setItem("conversation_id", conversationId);

          transcriptionEl.textContent = `You said: "${data.transcription}"`;
          recipeEl.innerHTML = markdownToHtml(data.llm_response);
          output.classList.add("show");
          loading.style.display = "none";
        } else showError(data.error || "Server error");
      } catch {
        showError("Failed to reach server. Is Flask running?");
      } finally {
        startBtn.disabled = false;
        textSubmit.disabled = false;
        openCameraBtn.disabled = false;
        photoActionBtn.disabled = true;
      }
    }

    // TEXT SUBMIT HANDLER
    textSubmit.onclick = async () => {
      stopTTS();
      const text = textInput.value.trim();
      if (!text) return showError("Please enter some ingredients.");

      // If a recording is currently running, prevent text submit.
      if (mediaRecorder && mediaRecorder.state === "recording") {
        return showError("Veuillez arrêter l'enregistrement vocal avant d'envoyer le texte.");
      }

      // Disable voice controls while the text request is in flight
      startBtn.disabled = true;
      stopBtn.disabled = true;
      textSubmit.disabled = true;

      openCameraBtn.disabled = true;
      photoActionBtn.disabled = true;

      loading.style.display = "block";
      errorDiv.style.display = "none";
      output.classList.remove("show");

      try {
        const response = await fetch("/texte", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, conversation_id: conversationId })
        });

        const data = await response.json();

        if (response.ok) {
          conversationId = data.conversation_id;
          localStorage.setItem("conversation_id", conversationId);

          transcriptionEl.textContent = `You wrote: "${text}"`;
          recipeEl.innerHTML = markdownToHtml(data.llm_response);
          output.classList.add("show");
          loading.style.display = "none";
          textInput.value = "";

        } else showError(data.error || "Server error");

      } catch {
        showError("Failed to reach /texte route.");
      } finally {
        // Re-enable controls after LLM response (or error)
        startBtn.disabled = false;
        stopBtn.disabled = true; // stop should remain disabled until recording starts
        textSubmit.disabled = false;
        openCameraBtn.disabled = false;
        photoActionBtn.disabled = true;
      }
    };

    // Markdown → HTML
    function markdownToHtml(text) {
      const lines = text.split('\n');
      let html = '';
      let inUl = false;
      let inOl = false;

      for (let line of lines) {
        line = line.trim();
        if (!line) { 
          // empty line → close any open lists
          if (inUl) { html += '</ul>'; inUl = false; }
          if (inOl) { html += '</ol>'; inOl = false; }
          continue;
        }

        // Heading
        if (line.startsWith('# ')) {
          if (inUl) { html += '</ul>'; inUl = false; }
          if (inOl) { html += '</ol>'; inOl = false; }
          html += `<h3>${line.slice(2)}</h3>`;
          continue;
        }

        // Unordered list
        if (line.startsWith('- ')) {
          if (inOl) { html += '</ol>'; inOl = false; }
          if (!inUl) { html += '<ul>'; inUl = true; }
          html += `<li>${line.slice(2)}</li>`;
          continue;
        }

        // Ordered list
        if (/^\d+\.\s/.test(line)) {
          if (inUl) { html += '</ul>'; inUl = false; }
          if (!inOl) { html += '<ol>'; inOl = true; }
          html += `<li>${line.replace(/^\d+\.\s/, '')}</li>`;
          continue;
        }

        // Paragraph
        if (inUl) { html += '</ul>'; inUl = false; }
        if (inOl) { html += '</ol>'; inOl = false; }
        html += `<p>${line}</p>`;
      }

      // Close any open lists at the end
      if (inUl) html += '</ul>';
      if (inOl) html += '</ol>';

      // Bold and italic
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

      return html;
    }


    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.style.display = "block";
      loading.style.display = "none";
      startBtn.disabled = false;
      textSubmit.disabled = false;
      openCameraBtn.disabled = false;
    }
  </script>

</body>
</html>